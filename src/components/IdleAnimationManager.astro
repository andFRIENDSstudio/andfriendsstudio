---
// IdleAnimationManager.astro - Manages idle animations based on inactivity
// TODO: Update IDLE_TIMEOUT to 30000 for project pages (currently 15000 for home)
---

<script>
  const IDLE_TIMEOUT = 15000; // 15 seconds of inactivity on home page
  
  let idleTimer: number | null = null;
  let currentAnimation: 'falling' | 'dvd' | null = null;
  let isAnimating = false;

  function resetIdleTimer() {
    // Clear existing timer
    if (idleTimer) clearTimeout(idleTimer);
    
    // Stop any running animation if user is active
    if (isAnimating) {
      stopCurrentAnimation();
    }
    
    // Start new idle timer
    idleTimer = setTimeout(startRandomAnimation, IDLE_TIMEOUT) as unknown as number;
  }

  function startRandomAnimation() {
    // Choose random animation (50/50 split)
    const animations: Array<'falling' | 'dvd'> = ['falling', 'dvd'];
    currentAnimation = animations[Math.floor(Math.random() * animations.length)];
    isAnimating = true;
    
    if (currentAnimation === 'falling') {
      (window as any).startFallingLogos?.();
    } else {
      (window as any).startDVDLogo?.();
    }
    
    // Animation will loop continuously until user activity
  }

  function stopCurrentAnimation() {
    if (currentAnimation === 'falling') {
      (window as any).stopFallingLogos?.();
    } else if (currentAnimation === 'dvd') {
      (window as any).stopDVDLogo?.();
    }
    currentAnimation = null;
    isAnimating = false;
  }

  // Track user activity
  const activityEvents = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
  
  activityEvents.forEach(event => {
    document.addEventListener(event, resetIdleTimer, { passive: true });
  });

  // Start idle detection
  resetIdleTimer();

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopCurrentAnimation();
    if (idleTimer) clearTimeout(idleTimer);
  });
</script>